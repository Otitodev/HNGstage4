╔═══════════════════════════════════════════════════════════════════════════════╗
║                    DISTRIBUTED NOTIFICATION SYSTEM                            ║
║                         Architecture Overview                                 ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                         EXTERNAL CLIENTS                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │ Web App  │  │Mobile App│  │  Backend │  │   API    │                   │
│  │          │  │          │  │ Services │  │ Clients  │                   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘                   │
└───────┼─────────────┼─────────────┼─────────────┼─────────────────────────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                      │
                      │ HTTPS/REST
                      │ POST /v1/notifications
                      ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                           API GATEWAY (Port 8000)                             ║
║  ┌─────────────────────────────────────────────────────────────────────┐    ║
║  │  FastAPI Application                                                 │    ║
║  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐        │    ║
║  │  │ Request        │  │ Circuit        │  │ Idempotency    │        │    ║
║  │  │ Validation     │  │ Breakers       │  │ Manager        │        │    ║
║  │  └────────────────┘  └────────────────┘  └────────────────┘        │    ║
║  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐        │    ║
║  │  │ Service        │  │ Retry Logic    │  │ Request        │        │    ║
║  │  │ Orchestration  │  │ (Exp Backoff)  │  │ Tracing        │        │    ║
║  │  └────────────────┘  └────────────────┘  └────────────────┘        │    ║
║  └─────────────────────────────────────────────────────────────────────┘    ║
╚═══════════════════════════════════════════════════════════════════════════════╝
        │                      │                      │
        │ GET /v1/users/{id}   │ POST /v1/templates  │ Publish Message
        │ X-Internal-Secret    │ /render             │
        ▼                      ▼                      ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  USER SERVICE    │  │ TEMPLATE SERVICE │  │    RABBITMQ      │
│   (Port 8002)    │  │   (Port 8001)    │  │  MESSAGE QUEUE   │
├──────────────────┤  ├──────────────────┤  ├──────────────────┤
│ • User Profiles  │  │ • Templates      │  │ Queues:          │
│ • Preferences    │  │ • Rendering      │  │  • notifications │
│ • Multi-language │  │ • Versioning     │  │  • email.queue   │
│ • CRUD Ops       │  │ • Caching        │  │  • push.queue    │
│                  │  │                  │  │  • failed.queue  │
└────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘
         │                     │                      │
         │ asyncpg             │ asyncpg              │ pika
         ▼                     ▼                      ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│   PostgreSQL     │  │   PostgreSQL     │  │  WORKERS         │
│     (Neon)       │  │     (Neon)       │  ├──────────────────┤
├──────────────────┤  ├──────────────────┤  │ Email Worker     │
│ Table: users     │  │ Table: templates │  │  ↓ SendGrid      │
│                  │  │                  │  │                  │
│ • user_id (PK)   │  │ • template_key   │  │ Push Worker      │
│ • email_address  │  │ • subject        │  │  ↓ Firebase FCM  │
│ • phone_number   │  │ • body           │  │                  │
│ • preferred_lang │  │ • html_body      │  │ SMS Worker       │
│ • preferences    │  │ • created_at     │  │  ↓ Twilio        │
│   (JSONB)        │  │                  │  │  (Future)        │
└──────────────────┘  └──────────────────┘  └──────────────────┘
         │                     │
         │                     │
         ▼                     ▼
╔═══════════════════════════════════════════════════════════════════════════════╗
║                         REDIS (Upstash) - Caching Layer                       ║
║  ┌─────────────────────────────────────────────────────────────────────┐    ║
║  │  Key-Value Store (REST API)                                          │    ║
║  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐        │    ║
║  │  │ User Cache     │  │ Template Cache │  │ Idempotency    │        │    ║
║  │  │ TTL: 1 hour    │  │ TTL: 1 hour    │  │ Keys           │        │    ║
║  │  │                │  │                │  │ TTL: 24 hours  │        │    ║
║  │  └────────────────┘  └────────────────┘  └────────────────┘        │    ║
║  └─────────────────────────────────────────────────────────────────────┘    ║
╚═══════════════════════════════════════════════════════════════════════════════╝


═══════════════════════════════════════════════════════════════════════════════
                            DATA FLOW SEQUENCE
═══════════════════════════════════════════════════════════════════════════════

┌────────┐     ┌─────────┐     ┌──────┐     ┌─────────┐     ┌─────────┐
│ Client │     │   API   │     │ User │     │Template │     │RabbitMQ │
│        │     │ Gateway │     │ Svc  │     │   Svc   │     │         │
└───┬────┘     └────┬────┘     └──┬───┘     └────┬────┘     └────┬────┘
    │               │              │              │               │
    │ 1. POST       │              │              │               │
    │ /notifications│              │              │               │
    ├──────────────>│              │              │               │
    │               │              │              │               │
    │               │ 2. GET       │              │               │
    │               │ /users/{id}  │              │               │
    │               ├─────────────>│              │               │
    │               │              │              │               │
    │               │ 3. User Data │              │               │
    │               │<─────────────┤              │               │
    │               │              │              │               │
    │               │ 4. POST /templates/render   │               │
    │               ├────────────────────────────>│               │
    │               │              │              │               │
    │               │ 5. Rendered Content         │               │
    │               │<────────────────────────────┤               │
    │               │              │              │               │
    │               │ 6. Publish Message          │               │
    │               ├────────────────────────────────────────────>│
    │               │              │              │               │
    │ 7. 202        │              │              │               │
    │ Accepted      │              │              │               │
    │<──────────────┤              │              │               │
    │               │              │              │               │
    │               │              │              │ 8. Consume    │
    │               │              │              │ & Deliver     │
    │               │              │              │<──────────────┤
    │               │              │              │               │
    │               │              │              │ 9. SendGrid/  │
    │               │              │              │    Firebase   │
    │               │              │              │               │
    ▼               ▼              ▼              ▼               ▼


═══════════════════════════════════════════════════════════════════════════════
                         RESILIENCE PATTERNS
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. CIRCUIT BREAKER PATTERN                                                  │
│                                                                              │
│    ┌─────────┐                                                              │
│    │ CLOSED  │ ──[5 failures]──> ┌──────┐                                  │
│    │ (Normal)│                    │ OPEN │                                  │
│    └────┬────┘ <──[Success]────── │(Block)│                                │
│         │                          └──┬───┘                                 │
│         │                             │                                     │
│         │                             │ [60s timeout]                       │
│         │                             ▼                                     │
│         │                          ┌──────────┐                             │
│         └──────[Success]───────────│HALF-OPEN │                             │
│                                    │  (Test)  │                             │
│                                    └──────────┘                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. RETRY WITH EXPONENTIAL BACKOFF                                           │
│                                                                              │
│    Attempt 1: ──[Fail]──> Wait 0.1s                                         │
│    Attempt 2: ──[Fail]──> Wait 0.2s                                         │
│    Attempt 3: ──[Fail]──> Wait 0.4s                                         │
│    Attempt 4: ──[Fail]──> Wait 0.8s                                         │
│    Attempt 5: ──[Fail]──> Wait 1.6s                                         │
│    Max Delay: 5.0s                                                           │
│    Jitter: ±25% randomization                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. IDEMPOTENCY                                                               │
│                                                                              │
│    Request 1 [Key: ABC123] ──> Process ──> Store Result ──> 202 Accepted   │
│    Request 2 [Key: ABC123] ──> Check Cache ──> Return Cached ──> 202       │
│    Request 3 [Key: ABC123] ──> Check Cache ──> Return Cached ──> 202       │
│                                                                              │
│    TTL: 24 hours                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. DEAD LETTER QUEUE (DLQ)                                                  │
│                                                                              │
│    Main Queue ──[Process]──> Success ──> Acknowledge                        │
│         │                                                                    │
│         └──[Fail 3x]──> DLQ ──> Manual Review/Retry                         │
│                                                                              │
│    DLQ TTL: 24 hours                                                         │
│    Max Length: 10,000 messages                                               │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                         DEPLOYMENT ARCHITECTURE
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                          PRODUCTION ENVIRONMENT                              │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                      Load Balancer (HTTPS)                          │    │
│  └────────────────────────────┬───────────────────────────────────────┘    │
│                                │                                             │
│                ┌───────────────┼───────────────┐                            │
│                │               │               │                            │
│                ▼               ▼               ▼                            │
│         ┌──────────┐    ┌──────────┐    ┌──────────┐                       │
│         │ Gateway  │    │ Gateway  │    │ Gateway  │                       │
│         │Instance 1│    │Instance 2│    │Instance N│                       │
│         └────┬─────┘    └────┬─────┘    └────┬─────┘                       │
│              │               │               │                              │
│              └───────────────┼───────────────┘                              │
│                              │                                              │
│              ┌───────────────┼───────────────┐                              │
│              │               │               │                              │
│              ▼               ▼               ▼                              │
│       ┌──────────┐    ┌──────────┐    ┌──────────┐                         │
│       │  User    │    │ Template │    │ RabbitMQ │                         │
│       │ Service  │    │ Service  │    │ Cluster  │                         │
│       │(Replicas)│    │(Replicas)│    │          │                         │
│       └────┬─────┘    └────┬─────┘    └────┬─────┘                         │
│            │               │               │                                │
│            ▼               ▼               ▼                                │
│       ┌──────────┐    ┌──────────┐    ┌──────────┐                         │
│       │PostgreSQL│    │PostgreSQL│    │  Workers │                         │
│       │  (Neon)  │    │  (Neon)  │    │(Replicas)│                         │
│       └──────────┘    └──────────┘    └──────────┘                         │
│            │               │                                                │
│            └───────┬───────┘                                                │
│                    ▼                                                        │
│              ┌──────────┐                                                   │
│              │  Redis   │                                                   │
│              │(Upstash) │                                                   │
│              └──────────┘                                                   │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                         MONITORING & OBSERVABILITY
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│  METRICS                    LOGS                      TRACES                │
│  ┌──────────┐              ┌──────────┐             ┌──────────┐           │
│  │ Request  │              │Structured│             │ Request  │           │
│  │   Rate   │              │   JSON   │             │   Flow   │           │
│  ├──────────┤              ├──────────┤             ├──────────┤           │
│  │ Error    │              │ Levels:  │             │ X-Request│           │
│  │   Rate   │              │ INFO     │             │   -ID    │           │
│  ├──────────┤              │ WARNING  │             ├──────────┤           │
│  │Response  │              │ ERROR    │             │ Service  │           │
│  │  Time    │              ├──────────┤             │   Hops   │           │
│  ├──────────┤              │Correlation│            ├──────────┤           │
│  │ Queue    │              │ Request  │             │ Timing   │           │
│  │  Depth   │              │   IDs    │             │  Data    │           │
│  ├──────────┤              └──────────┘             └──────────┘           │
│  │ Cache    │                                                               │
│  │Hit Rate  │                                                               │
│  └──────────┘                                                               │
│                                                                              │
│  HEALTH CHECKS              ALERTS                                           │
│  ┌──────────┐              ┌──────────┐                                    │
│  │ /health  │              │ Circuit  │                                    │
│  │ Endpoint │              │ Breaker  │                                    │
│  ├──────────┤              │  Open    │                                    │
│  │ Service  │              ├──────────┤                                    │
│  │  Status  │              │ Queue    │                                    │
│  ├──────────┤              │ Backlog  │                                    │
│  │ Database │              ├──────────┤                                    │
│  │  Conn    │              │ Error    │                                    │
│  ├──────────┤              │  Spike   │                                    │
│  │  Redis   │              ├──────────┤                                    │
│  │  Conn    │              │ Service  │                                    │
│  ├──────────┤              │  Down    │                                    │
│  │ RabbitMQ │              └──────────┘                                    │
│  │  Conn    │                                                               │
│  └──────────┘                                                               │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                              LEGEND
═══════════════════════════════════════════════════════════════════════════════

  ──>   Synchronous Request/Response
  ═══>  Asynchronous Message
  ┌─┐   Service/Component
  ╔═╗   Critical Component
  │     Data Flow
  ▼     Direction of Flow
  [x]   Condition/Trigger
  TTL   Time To Live
  PK    Primary Key
  JSONB JSON Binary (PostgreSQL)
  FCM   Firebase Cloud Messaging
  DLQ   Dead Letter Queue
  QoS   Quality of Service

═══════════════════════════════════════════════════════════════════════════════
